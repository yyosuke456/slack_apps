const { App } = require("@slack/bolt");

const app = new App({
  logLevel: "debug", // これはログレベルの調整なので削除しても OK です
  socketMode: true,
  token: process.env.SLACK_BOT_TOKEN,
  appToken: process.env.SLACK_APP_TOKEN,
});

let replyFlg = 0;

// グローバルショートカット
app.shortcut("socket-mode-shortcut", async ({ ack, body, client }) => {
  await ack();
  await client.views.open({
    trigger_id: body.trigger_id,
    view: {
      type: "modal",
      callback_id: "modal-id",
      title: {
        type: "plain_text",
        text: "タスク登録",
      },
      submit: {
        type: "plain_text",
        text: "送信",
      },
      close: {
        type: "plain_text",
        text: "キャンセル",
      },
      blocks: [
        {
          type: "input",
          block_id: "input-task",
          element: {
            type: "plain_text_input",
            action_id: "input",
            multiline: true,
            placeholder: {
              type: "plain_text",
              text: "タスクの詳細・期限などを書いてください",
            },
          },
          label: {
            type: "plain_text",
            text: "タスク",
          },
        },
      ],
    },
  });
});

function getRandomReply() {
  const replyList = [
    "なんであたしがおまえを雇わなきゃならないんだい！？見るからにグズで！甘ったれで！泣き虫で！頭の悪い小娘に、仕事なんかあるもんかね！お断りだね。これ以上穀潰しを増やしてどうしようっていうんだい！それとも……一番つらーーいきつーーい仕事を死ぬまでやらせてやろうかぁ……？",
    "うるさいね、静かにしておくれ。",
    "馬鹿なおしゃべりはやめとくれ。そんなひょろひょろに何が出来るのさ。",
    "まァだそれを言うのかい！",
    "だァーーーまァーーーれェーーー！！！",
    "おっ おっ おっ おっ おっ おっ おっ",
    "わかったから静かにしておくれ！おおぉお～よ～しよし～……",
    "わかったから静かにしておくれ！おおぉお～よ～しよし～……",
  ];
  const index = Math.floor(Math.random() * replyList.length);
  return replyList[index];
}
app.view("modal-id", async ({ ack, view, logger }) => {
  logger.info(`Submitted data: ${view.state.values}`);
  await ack();
});

// イベント API
app.message("ここで働かせてください！", async ({ message, say }) => {
  const reply = getRandomReply();
  await say(`<@${message.user}> ` + reply);
  if (reply == "わかったから静かにしておくれ！おおぉお～よ～しよし～……") {
    await say(
      `<@${message.user}> 契約書だよ。そこに名前を書きな。働かせてやる。その代わり嫌だとか、帰りたいとか言ったらすぐ子豚にしてやるからね。`
    );
    replyFlg = 1;
  }
});

app.message("ここで働きたいんです！", async ({ message, say }) => {
  const reply = getRandomReply();
  await say(`<@${message.user}> ` + reply);
  if (reply == "わかったから静かにしておくれ！おおぉお～よ～しよし～……") {
    await say(
      `<@${message.user}> 契約書だよ。そこに名前を書きな。働かせてやる。その代わり嫌だとか、帰りたいとか言ったらすぐ子豚にしてやるからね。`
    );
    replyFlg = 1;
  }
});

app.message("", async ({ message, say }) => {
  if (replyFlg == 1) {
    const name = message.text;
    const random = Math.round(Math.random() * name.length) - 1;
    const newName = name.substr(random, 1);
    await say(`<@${message.user}> フン。${name}というのかい。贅沢な名だねぇ。`);
    await say(
      `@${newName} 今からお前の名前は${newName}だ。いいかい、${newName}だよ。分かったら返事をするんだ、${newName}!!`
    );
    replyFlg = 0;
  }
});

(async () => {
  await app.start();
  console.log("⚡️ Bolt app started");
})();
